<h1>Editing Post</h1>

<%= form_with model: @post, local: true do |f| %>
  <div class="code-block">
    <div>markdownで記入</div>
    <%= f.text_field :title, placeholder: "#{@post.title}" %>
    <%= f.text_area :content, id: 'content', placeholder: "#{@post.content}" %>
  </div>
  <div class="code-block">
    <div>表示されるページ</div>
    <div id="code_markdown"></div>   <%# ここにMarkdownに変換された入力内容が入る %>
  </div>
<% end %>

<%= link_to 'Show', @post %> |
<%= link_to 'Back', posts_path %>

<script>
function markdownCode() {
  const codeInput = document.getElementById('content');  // idが'content'のもの(textarea)
  const codeMarkdown = document.getElementById('code_markdown');
  if (codeInput == null || codeMarkdown == null) {
    return;
  }

  codeInput.addEventListener('input', () => {
    const HTML = `${codeInput.value}`;
    codeMarkdown.innerHTML = marked(HTML);
    const pre_code_nodes = document.querySelectorAll("pre code");  // ここがポイント
    for(let i = 0; i < pre_code_nodes.length; ++i){                // ここがポイント
      hljs.highlightBlock(pre_code_nodes[i]);                      // ここがポイント
    }
  });
};
window.onload = function(){
    const codeInput = document.getElementById('content');  // idが'content'のもの(textarea)
    const codeMarkdown = document.getElementById('code_markdown');
    const HTML = `${codeInput.value}`;
    codeMarkdown.innerHTML = marked(HTML);
    const pre_code_nodes = document.querySelectorAll("pre code");  // ここがポイント
    for(let i = 0; i < pre_code_nodes.length; ++i){                // ここがポイント
      hljs.highlightBlock(pre_code_nodes[i]);                      // ここがポイント
    }
}
window.addEventListener("load", markdownCode);
</script>